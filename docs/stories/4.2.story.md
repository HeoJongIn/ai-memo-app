# Story 4.2: 노트 내용 기반 자동 요약 생성

## Status
Ready for Review

## Story
**As a** 사용자,
**I want** 노트 내용을 기반으로 AI가 자동으로 요약을 생성하겠습니다,
**so that** 긴 노트를 빠르게 파악하고 핵심 내용을 이해할 수 있습니다.

## Acceptance Criteria
1. 노트 상세 페이지에서 AI 요약 생성 버튼 제공
2. Gemini API를 통한 3-6개 불릿 포인트 요약 생성
3. 요약 생성 중 로딩 상태 표시
4. 생성된 요약을 노트 상세 페이지에 표시
5. 요약 생성 실패 시 사용자 친화적 에러 메시지 표시
6. 요약 생성 성공 시 데이터베이스에 저장

## Tasks / Subtasks
- [x] 요약 생성 UI 컴포넌트 구현 (AC: 1)
  - [x] 노트 상세 페이지에 "AI 요약 생성" 버튼 추가
  - [x] 버튼 클릭 시 요약 생성 서버 액션 호출
  - [x] 버튼 비활성화 상태 관리 (이미 요약이 있는 경우)
- [x] 요약 생성 서버 액션 구현 (AC: 2)
  - [x] 기존 generateSummaryAction 활용
  - [x] 노트 소유권 검증 로직 추가
  - [x] 요약 생성 결과 반환
- [x] 로딩 상태 관리 구현 (AC: 3)
  - [x] 요약 생성 중 로딩 스피너 표시
  - [x] 버튼 비활성화 및 로딩 텍스트 표시
  - [x] 사용자 인터랙션 방지
- [x] 요약 표시 UI 구현 (AC: 4)
  - [x] 생성된 요약을 불릿 포인트 형태로 표시
  - [x] 요약 섹션 헤더 및 스타일링
  - [x] 기존 요약이 있는 경우 표시
- [x] 에러 핸들링 구현 (AC: 5)
  - [x] API 호출 실패 시 에러 토스트 표시
  - [x] 네트워크 에러 처리
  - [x] 사용자 권한 에러 처리
- [x] 데이터베이스 저장 로직 구현 (AC: 6)
  - [x] summaries 테이블에 요약 데이터 저장
  - [x] 중복 요약 방지 로직
  - [x] 요약 생성 시간 기록

## Dev Notes

### 이전 스토리 인사이트
- 스토리 4.1에서 Gemini API 설정 및 연동이 완료됨
- generateSummaryAction 서버 액션이 이미 구현되어 있음
- 토큰 제한 관리 및 에러 핸들링 로직이 구축됨
- API 연결 테스트가 성공적으로 완료됨

### 데이터 모델
- **notes 테이블**: 요약할 노트 데이터 (id, user_id, title, content) [Source: architecture.md#2]
- **summaries 테이블**: AI 생성 요약 저장 (note_id, model, content, created_at) [Source: architecture.md#2]
- **사용자 스코프**: 사용자 ID 기반 노트 소유권 검증 [Source: architecture.md#3]

### API 명세
- **기존 서버 액션**: generateSummaryAction 활용 (lib/actions/ai.ts) [Source: architecture.md#4]
- **Gemini API**: gemini-2.5-flash 모델 사용 [Source: architecture.md#1]
- **토큰 제한**: 8k 토큰 제한 관리 [Source: architecture.md#6]
- **에러 핸들링**: 재시도 로직 및 사용자 친화적 메시지 [Source: architecture.md#6]

### 컴포넌트 명세
- **노트 상세 페이지**: app/notes/[id]/page.tsx 수정
- **요약 표시**: 불릿 포인트 형태의 UI 컴포넌트
- **로딩 상태**: shadcn/ui 컴포넌트 활용
- **에러 처리**: toast 컴포넌트를 통한 에러 메시지 표시

### 파일 위치
- **노트 상세 페이지**: app/notes/[id]/page.tsx (수정)
- **요약 표시 컴포넌트**: components/notes/note-summary.tsx (새로 생성)
- **기존 서버 액션**: lib/actions/ai.ts (활용)
- **테스트 파일**: __tests__/components/notes/note-summary.test.tsx (새로 생성)

### 기술적 제약사항
- **프레임워크**: Next.js App Router 사용 [Source: architecture.md#1]
- **서버 로직**: Server Actions으로 구현 [Source: architecture.md#1]
- **UI 컴포넌트**: shadcn/ui + Tailwind CSS 사용 [Source: architecture.md#1]
- **보안**: 사용자 스코프 기반 권한 제어 [Source: architecture.md#3]

### 성능 고려사항
- **토큰 제한**: 요약 길이 제한(8k 토큰)으로 성능 가드레일 적용 [Source: architecture.md#6]
- **비동기 처리**: 요약 생성 중 사용자 인터랙션 방지
- **캐싱**: 동일 노트에 대한 중복 요약 생성 방지
- **로딩 상태**: 사용자 경험 개선을 위한 명확한 피드백

### Testing
- **테스트 프레임워크**: Jest (기존 설정 활용)
- **테스트 파일 위치**: __tests__/ 디렉토리
- **테스트 대상**: 요약 생성 UI 컴포넌트, 서버 액션 호출, 에러 핸들링
- **테스트 표준**: 각 컴포넌트와 함수에 대한 단위 테스트 작성 필수
- **특이사항**: 사용자 인터랙션 테스트, 로딩 상태 테스트, 에러 시나리오 테스트 포함

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | 초기 스토리 생성 | Scrum Master |
| 2024-12-19 | 1.1 | 스토리 구현 완료 및 테스트 통과 | Dev Agent |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (Dev Agent)

### Debug Log References
- 요약 컴포넌트 테스트 통과: 모든 사용자 인터랙션 시나리오 검증 완료
- 기존 서버 액션 활용: generateSummaryAction과 getSummaryAction 연동 성공
- 로딩 상태 관리: 비동기 처리 중 사용자 인터랙션 방지 구현

### Completion Notes List
- ✅ NoteSummary 컴포넌트 생성 및 구현 완료
- ✅ 노트 상세 페이지에 요약 컴포넌트 통합
- ✅ getSummaryAction 서버 액션 추가
- ✅ 요약 생성 버튼 및 로딩 상태 관리
- ✅ 불릿 포인트 형태 요약 표시 UI
- ✅ 에러 핸들링 및 토스트 메시지 표시
- ✅ 요약 재생성 기능 구현
- ✅ 포괄적인 단위 테스트 작성 및 통과 (9개 테스트)

### File List
- `components/notes/note-summary.tsx` - 요약 표시 컴포넌트 (새로 생성)
- `app/notes/[id]/page.tsx` - 노트 상세 페이지 수정 (요약 컴포넌트 통합)
- `lib/actions/notes.ts` - getSummaryAction 서버 액션 추가
- `__tests__/components/notes/note-summary.test.tsx` - 요약 컴포넌트 테스트 (새로 생성)

## QA Results
*This section will be populated by the QA agent after implementation review*
