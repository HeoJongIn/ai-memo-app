# Story 4.7: AI 처리 에러 핸들링

## Status
Ready for Review

## Story
**As a** 사용자,
**I want** AI 처리 중 발생하는 에러를 적절히 처리하고 복구할 수 있겠습니다,
**so that** AI 기능 사용 중 문제가 발생해도 안정적으로 서비스를 이용할 수 있습니다.

## Acceptance Criteria
1. API 호출 실패 시 사용자에게 명확한 에러 메시지 표시
2. 네트워크 오류 시 자동 재시도 기능 제공
3. 토큰 제한 초과 시 적절한 안내 메시지 표시
4. AI 응답 파싱 실패 시 기본값 제공
5. 서버 오류 시 사용자 데이터 보호 및 롤백
6. 에러 로깅 및 모니터링 시스템 구축
7. 사용자 친화적인 에러 복구 가이드 제공

## Tasks / Subtasks
- [x] API 에러 핸들링 구현 (AC: 1, 2, 3)
  - [x] Gemini API 호출 실패 시 에러 분류 및 처리
  - [x] 네트워크 타임아웃 및 연결 실패 처리
  - [x] 토큰 제한 초과 시 사용자 안내 메시지
  - [x] API 응답 검증 및 파싱 에러 처리
- [x] 재시도 로직 구현 (AC: 2)
  - [x] 지수 백오프를 적용한 자동 재시도
  - [x] 재시도 횟수 제한 및 사용자 알림
  - [x] 재시도 상태 표시 UI 구현
- [x] 데이터 보호 및 롤백 구현 (AC: 5)
  - [x] AI 처리 실패 시 원본 데이터 보존
  - [x] 부분적 성공 시 데이터 일관성 유지
  - [x] 사용자 작업 롤백 기능
- [x] 에러 로깅 시스템 구현 (AC: 6)
  - [x] 클라이언트 사이드 에러 로깅
  - [x] 서버 사이드 에러 추적
  - [x] 에러 통계 및 모니터링 대시보드
- [x] 사용자 경험 개선 (AC: 4, 7)
  - [x] 에러 발생 시 대안 제시
  - [x] 복구 가이드 및 도움말 제공
  - [x] 에러 상태별 맞춤형 UI 표시

## Dev Notes

### Previous Story Insights
- Story 4.6에서 InlineEdit 컴포넌트 구현 시 에러 처리 패턴 확립
- handleUpdateTags/handleUpdateSummary에서 Promise 기반 에러 처리 구현
- 토스트 메시지를 통한 사용자 피드백 시스템 구축

### Data Models
- **summaries 테이블**: noteId, model, content, createdAt [Source: architecture.md#데이터-모델]
- **note_tags 테이블**: noteId, tag [Source: architecture.md#데이터-모델]
- **notes 테이블**: id, user_id, title, content, created_at, updated_at [Source: architecture.md#데이터-모델]

### API Specifications
- **Gemini API**: Google Gemini API 연동, 8k 토큰 제한 [Source: architecture.md#기술-스택]
- **서버 액션**: saveNote, deleteNote, regenerateAI [Source: architecture.md#서버-액션]
- **권한 스코프**: 사용자 ID 스코프로 소유자만 CRUD 가능 [Source: architecture.md#보안]

### Component Specifications
- **AIStatusIndicator**: 로딩, 완료, 에러 상태 표시 컴포넌트 (Story 4.4에서 구현)
- **Toast 시스템**: 사용자 피드백을 위한 토스트 메시지 컴포넌트
- **InlineEdit**: 인라인 편집 기능 (Story 4.6에서 구현)

### File Locations
- `lib/actions/ai.ts` - AI 관련 서버 액션 (Gemini API 호출, 에러 처리)
- `components/notes/note-summary.tsx` - 요약 컴포넌트
- `components/notes/note-tags.tsx` - 태그 컴포넌트
- `components/ui/toast.tsx` - 토스트 컴포넌트
- `lib/utils.ts` - 유틸리티 함수

### Testing Requirements
- Jest 테스트 프레임워크 사용
- 컴포넌트 단위 테스트: `__tests__/components/`
- 서버 액션 테스트: `__tests__/lib/actions/`
- 에러 시나리오 테스트 케이스 포함
- Mock을 활용한 API 실패 상황 테스트

### Technical Constraints
- **토큰 제한**: Gemini API 8k 토큰 제한 준수 [Source: architecture.md#배포/운영]
- **성능 가드레일**: 요약 길이 제한, 무료 할당 활용 [Source: architecture.md#배포/운영]
- **보안**: Supabase 서비스 롤 키는 서버 전용 [Source: architecture.md#보안]
- **Next.js App Router**: Server Actions 사용 [Source: architecture.md#기술-스택]

## Testing

### Test File Location
- `__tests__/lib/actions/ai-error-handling.test.ts` - AI 에러 처리 서버 액션 테스트
- `__tests__/components/notes/error-handling.test.tsx` - 에러 처리 UI 컴포넌트 테스트

### Test Standards
- Jest 테스트 프레임워크 사용
- 각 에러 시나리오별 테스트 케이스 작성
- Mock을 활용한 API 실패 상황 시뮬레이션
- 사용자 경험 관점에서의 에러 처리 검증

### Testing Frameworks and Patterns
- Jest + React Testing Library
- Mock 함수를 활용한 API 호출 실패 시뮬레이션
- 사용자 인터랙션 테스트 (에러 발생 시 사용자 반응)

### Specific Testing Requirements
- API 호출 실패 시 에러 메시지 표시 테스트
- 재시도 로직 동작 검증 테스트
- 데이터 롤백 기능 테스트
- 에러 로깅 시스템 테스트

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | 스토리 4.7 초기 생성 | Scrum Master |
| 2024-12-19 | 1.1 | 스토리 4.7 구현 완료 | Dev Agent |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (2024-12-19)

### Debug Log References
- 에러 분류 로직 개선: 네트워크, API, 파싱 에러 패턴 확장
- 재시도 로직 구현: 지수 백오프 + 랜덤 지터 적용
- 데이터 백업/롤백 시스템: 메모리 기반 백업 매니저 구현
- 에러 모니터링: 통계 수집 및 패턴 분석 시스템 구축

### Completion Notes List
1. **API 에러 핸들링**: 9가지 에러 타입 분류 시스템 구현 (AUTHENTICATION_ERROR, AUTHORIZATION_ERROR, TOKEN_LIMIT_EXCEEDED, NETWORK_ERROR, API_ERROR, PARSING_ERROR, DATABASE_ERROR, VALIDATION_ERROR, UNKNOWN_ERROR)
2. **재시도 로직**: useRetry 훅과 RetryIndicator 컴포넌트로 자동/수동 재시도 기능 구현
3. **데이터 보호**: backupBeforeAIProcessing과 rollbackOnFailure 함수로 원본 데이터 보존
4. **에러 모니터링**: ErrorMonitor 클래스로 에러 통계 수집 및 패턴 분석
5. **사용자 경험**: ErrorRecoveryGuide 컴포넌트로 에러별 맞춤형 복구 가이드 제공

### File List
- `lib/types/ai-errors.ts` - AI 에러 타입 정의 및 인터페이스
- `lib/actions/ai.ts` - 강화된 에러 처리 및 분류 시스템
- `hooks/use-retry.ts` - 재시도 로직 관리 훅
- `components/ui/retry-indicator.tsx` - 재시도 상태 표시 컴포넌트
- `lib/utils/data-backup.ts` - 데이터 백업 및 롤백 유틸리티
- `lib/utils/error-monitoring.ts` - 에러 모니터링 및 통계 시스템
- `components/ui/error-recovery-guide.tsx` - 에러 복구 가이드 컴포넌트
- `components/admin/error-monitoring-dashboard.tsx` - 에러 모니터링 대시보드
- `components/notes/note-summary.tsx` - 에러 처리 통합 (백업/롤백/재시도)
- `components/notes/note-tags.tsx` - 에러 처리 통합 (백업/롤백/재시도)
- `__tests__/lib/actions/ai-error-handling.test.ts` - AI 에러 처리 테스트
- `__tests__/components/notes/error-handling.test.tsx` - 에러 처리 UI 테스트

## QA Results
*This section will be populated by the QA agent during review*
