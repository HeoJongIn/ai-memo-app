# Story 4.1: Gemini API 설정 및 연동

## Status
Ready for Review

## Story
**As a** 개발자,
**I want** Google Gemini API를 설정하고 연동하겠습니다,
**so that** 노트의 자동 요약과 태그 생성 기능을 구현할 수 있습니다.

## Acceptance Criteria
1. Google Gemini API 키를 환경 변수로 안전하게 설정
2. Gemini API 클라이언트 라이브러리 설치 및 설정
3. API 호출을 위한 서버 액션 함수 구현
4. 토큰 제한 관리 (8k 토큰) 구현
5. API 에러 핸들링 및 재시도 로직 구현
6. API 호출 테스트 및 검증

## Tasks / Subtasks
- [x] Google Gemini API 키 설정 (AC: 1)
  - [x] Supabase 프로젝트에서 환경 변수 설정
  - [x] .env.local 파일에 GEMINI_API_KEY 추가
  - [x] 환경 변수 보안 검증
- [x] Gemini API 클라이언트 설정 (AC: 2)
  - [x] @google/genai 패키지 설치
  - [x] GoogleGenAI 클라이언트 초기화 함수 구현
  - [x] 모델 설정 (gemini-2.0-flash-001) 구성
- [x] 서버 액션 함수 구현 (AC: 3)
  - [x] lib/actions/ai.ts 파일 생성
  - [x] generateSummary 서버 액션 구현
  - [x] generateTags 서버 액션 구현
  - [x] 공통 API 호출 유틸리티 함수 구현
- [x] 토큰 제한 관리 구현 (AC: 4)
  - [x] 입력 텍스트 토큰 수 계산 함수
  - [x] 8k 토큰 제한 검증 로직
  - [x] 토큰 초과 시 에러 처리
- [x] 에러 핸들링 및 재시도 로직 구현 (AC: 5)
  - [x] API 호출 실패 시 재시도 로직 (최대 3회)
  - [x] 네트워크 타임아웃 처리
  - [x] API 할당량 초과 에러 처리
  - [x] 사용자 친화적인 에러 메시지
- [x] 테스트 및 검증 (AC: 6)
  - [x] API 연결 테스트 함수 작성
  - [x] 토큰 계산 로직 단위 테스트
  - [x] 에러 핸들링 시나리오 테스트
  - [x] 실제 API 호출 통합 테스트

## Dev Notes

### 이전 스토리 인사이트
- Epic 2에서 노트 관리 시스템이 완성되어 AI 처리할 노트 데이터가 준비됨
- 사용자 인증 시스템이 구축되어 사용자 스코프 기반 보안 적용 가능
- Server Actions 패턴이 확립되어 AI 서버 액션도 동일한 패턴으로 구현

### 데이터 모델
- **notes 테이블**: AI 처리할 노트 데이터 (id, user_id, title, content) [Source: architecture.md#2]
- **summaries 테이블**: AI 생성 요약 저장 (note_id, model, content, created_at) [Source: architecture.md#2]
- **note_tags 테이블**: AI 생성 태그 저장 (note_id, tag) [Source: architecture.md#2]

### API 명세
- **Google Gemini API**: gemini-2.5-flash 모델 사용 (@google/genai 패키지) [Source: architecture.md#1]
- **패키지 설치**: `npm install @google/genai` (올바른 패키지명)
- **클라이언트 초기화**: `new GoogleGenAI({apiKey: process.env.GEMINI_API_KEY})`
- **API 호출**: `ai.models.generateContent({model: "gemini-2.5-flash", contents: "prompt"})`
- **토큰 제한**: 8k 토큰 제한 관리 [Source: architecture.md#6]
- **서버 액션**: regenateAI 서버 액션 구현 예정 [Source: architecture.md#4]

### 컴포넌트 명세
- AI 서버 액션은 클라이언트에서 직접 호출하지 않고 Server Actions로만 처리 [Source: architecture.md#1]
- 사용자 스코프 기반 보안으로 소유자만 AI 처리 가능 [Source: architecture.md#3]

### 파일 위치
- **서버 액션**: `lib/actions/ai.ts` (새로 생성)
- **환경 변수**: `.env.local` (GEMINI_API_KEY 추가)
- **테스트 파일**: `__tests__/lib/actions/ai.test.ts` (새로 생성)

### 기술적 제약사항
- **프레임워크**: Next.js App Router 사용 [Source: architecture.md#1]
- **서버 로직**: Server Actions으로 구현 [Source: architecture.md#1]
- **AI 모델**: Google Gemini API 사용 (@google/genai 패키지) [Source: architecture.md#1]
- **보안**: Supabase 서비스 롤 키는 서버 전용 [Source: architecture.md#3]

### 성능 고려사항
- **토큰 제한**: 요약 길이 제한(8k 토큰)으로 성능 가드레일 적용 [Source: architecture.md#6]
- **API 할당량**: Gemini 무료 할당 활용 [Source: architecture.md#6]
- **재시도 로직**: API 호출 실패 시 최대 3회 재시도
- **환경 변수**: GEMINI_API_KEY를 .env.local에 설정하여 자동 인증

### 패키지 사용법 (Context7 참조)
- **올바른 패키지**: `@google/genai` (기존 `@google/generative-ai`는 deprecated)
- **기본 사용법**:
  ```javascript
  import { GoogleGenAI } from '@google/genai';
  const ai = new GoogleGenAI({apiKey: process.env.GEMINI_API_KEY});
  const response = await ai.models.generateContent({
    model: "gemini-2.5-flash",
    contents: "프롬프트 텍스트"
  });
  console.log(response.text);
  ```
- **환경 변수 자동 인증**: `new GoogleGenAI({})`로 빈 객체 전달 시 GEMINI_API_KEY 환경 변수 자동 사용

### Testing
- **테스트 프레임워크**: Jest (기존 설정 활용)
- **테스트 파일 위치**: `__tests__/` 디렉토리
- **테스트 대상**: API 클라이언트 초기화, 토큰 계산, 에러 핸들링, 재시도 로직
- **테스트 표준**: 각 함수에 대한 단위 테스트 작성 필수
- **특이사항**: 실제 API 호출은 통합 테스트로 분리, 모킹을 통한 단위 테스트 우선

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | 초기 스토리 생성 | Scrum Master |
| 2024-12-19 | 1.1 | 패키지 정보 업데이트 (@google/genai) | Scrum Master |
| 2024-12-19 | 1.2 | 스토리 구현 완료 및 테스트 통과 | Dev Agent |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (Dev Agent)

### Debug Log References
- API 연결 테스트 성공: 실제 Gemini API 호출 확인됨
- 테스트 모킹 이슈 해결: Drizzle ORM 모킹 구조 수정
- 환경 변수 로딩 확인: dotenv를 통한 .env.local 파일 로딩 검증

### Completion Notes List
- ✅ @google/genai 패키지 설치 및 설정 완료
- ✅ GoogleGenAI 클라이언트 초기화 함수 구현
- ✅ 토큰 계산 및 제한 검증 로직 구현 (8k 토큰)
- ✅ 재시도 로직 구현 (최대 3회, 지수 백오프)
- ✅ 사용자 인증 및 노트 소유권 검증
- ✅ 요약 생성 서버 액션 구현 (generateSummaryAction)
- ✅ 태그 생성 서버 액션 구현 (generateTagsAction)
- ✅ 통합 AI 처리 서버 액션 구현 (generateAIProcessingAction)
- ✅ API 연결 테스트 함수 구현 (testGeminiConnectionAction)
- ✅ 포괄적인 단위 테스트 작성 및 통과
- ✅ 실제 API 연결 테스트 성공

### File List
- `lib/actions/ai.ts` - AI 서버 액션 함수들 (새로 생성)
- `__tests__/lib/actions/ai.test.ts` - AI 서버 액션 테스트 (새로 생성)
- `.env.local` - GEMINI_API_KEY 환경 변수 추가
- `package.json` - @google/genai 의존성 추가

## QA Results
*This section will be populated by the QA agent after implementation review*
