# Story 4.3: 노트 내용 기반 자동 태그 생성

## Status
Ready for Review

## Story
**As a** 사용자,
**I want** 노트 내용을 기반으로 AI가 자동으로 관련 태그를 생성하겠습니다,
**so that** 노트를 체계적으로 분류하고 검색하기 쉽게 만들 수 있습니다.

## Acceptance Criteria
1. 노트 상세 페이지에서 AI 태그 생성 버튼 제공
2. Gemini API를 통한 최대 6개까지 관련성 높은 태그 생성
3. 태그 생성 중 로딩 상태 표시
4. 생성된 태그를 노트 상세 페이지에 표시
5. 태그 생성 실패 시 사용자 친화적 에러 메시지 표시
6. 태그 생성 성공 시 데이터베이스에 저장
7. 기존 태그가 있는 경우 덮어쓰기 옵션 제공

## Tasks / Subtasks
- [x] 태그 생성 UI 컴포넌트 구현 (AC: 1)
  - [x] 노트 상세 페이지에 "AI 태그 생성" 버튼 추가
  - [x] 버튼 클릭 시 태그 생성 서버 액션 호출
  - [x] 기존 태그가 있는 경우 덮어쓰기 확인 다이얼로그 표시
- [x] 태그 생성 서버 액션 구현 (AC: 2)
  - [x] Gemini API를 통한 태그 생성 로직 구현
  - [x] 노트 소유권 검증 로직 추가
  - [x] 최대 6개 태그 제한 및 관련성 검증
  - [x] 태그 생성 결과 반환
- [x] 로딩 상태 관리 구현 (AC: 3)
  - [x] 태그 생성 중 로딩 스피너 표시
  - [x] 버튼 비활성화 및 로딩 텍스트 표시
  - [x] 사용자 인터랙션 방지
- [x] 태그 표시 UI 구현 (AC: 4)
  - [x] 생성된 태그를 배지 형태로 표시
  - [x] 태그 섹션 헤더 및 스타일링
  - [x] 기존 태그가 있는 경우 표시
- [x] 에러 핸들링 구현 (AC: 5)
  - [x] API 호출 실패 시 에러 토스트 표시
  - [x] 네트워크 에러 처리
  - [x] 사용자 권한 에러 처리
- [x] 데이터베이스 저장 로직 구현 (AC: 6)
  - [x] note_tags 테이블에 태그 데이터 저장
  - [x] 기존 태그 삭제 후 새 태그 삽입
  - [x] 태그 생성 시간 기록
- [x] 덮어쓰기 옵션 구현 (AC: 7)
  - [x] 기존 태그 존재 시 확인 다이얼로그 표시
  - [x] 사용자 선택에 따른 태그 처리 로직
  - [x] 취소 시 기존 태그 유지

## Dev Notes

### 이전 스토리 인사이트
- 스토리 4.1에서 Gemini API 설정 및 연동이 완료됨
- 스토리 4.2에서 요약 생성 기능이 구현되어 generateSummaryAction 패턴 참고 가능
- 기존 AI 서버 액션 구조와 에러 핸들링 로직 활용 가능
- 로딩 상태 관리 및 사용자 인터랙션 방지 패턴 적용 가능

### 데이터 모델
- **notes 테이블**: 태그를 생성할 노트 데이터 (id, user_id, title, content) [Source: architecture.md#2]
- **note_tags 테이블**: AI 생성 태그 저장 (note_id, tag) [Source: architecture.md#2]
- **사용자 스코프**: 사용자 ID 기반 노트 소유권 검증 [Source: architecture.md#3]

### API 명세
- **Gemini API**: gemini-2.5-flash 모델 사용 [Source: architecture.md#1]
- **토큰 제한**: 8k 토큰 제한 관리 [Source: architecture.md#6]
- **에러 핸들링**: 재시도 로직 및 사용자 친화적 메시지 [Source: architecture.md#6]
- **태그 제한**: 최대 6개까지 관련성 높은 태그 생성

### 컴포넌트 명세
- **노트 상세 페이지**: app/notes/[id]/page.tsx 수정
- **태그 표시**: shadcn/ui Badge 컴포넌트 활용
- **로딩 상태**: shadcn/ui 컴포넌트 활용
- **에러 처리**: toast 컴포넌트를 통한 에러 메시지 표시
- **확인 다이얼로그**: shadcn/ui Dialog 컴포넌트 활용

### 파일 위치
- **노트 상세 페이지**: app/notes/[id]/page.tsx (수정)
- **태그 생성 서버 액션**: lib/actions/ai.ts (수정)
- **태그 표시 컴포넌트**: components/notes/note-tags.tsx (새로 생성)
- **테스트 파일**: __tests__/components/notes/note-tags.test.tsx (새로 생성)

### 기술적 제약사항
- **프레임워크**: Next.js App Router 사용 [Source: architecture.md#1]
- **서버 로직**: Server Actions으로 구현 [Source: architecture.md#1]
- **UI 컴포넌트**: shadcn/ui + Tailwind CSS 사용 [Source: architecture.md#1]
- **보안**: 사용자 스코프 기반 권한 제어 [Source: architecture.md#3]

### 성능 고려사항
- **토큰 제한**: 태그 생성 길이 제한(8k 토큰)으로 성능 가드레일 적용 [Source: architecture.md#6]
- **비동기 처리**: 태그 생성 중 사용자 인터랙션 방지
- **캐싱**: 동일 노트에 대한 중복 태그 생성 방지
- **로딩 상태**: 사용자 경험 개선을 위한 명확한 피드백

### Testing
- **테스트 프레임워크**: Jest (기존 설정 활용)
- **테스트 파일 위치**: __tests__/ 디렉토리
- **테스트 대상**: 태그 생성 UI 컴포넌트, 서버 액션 호출, 에러 핸들링, 덮어쓰기 로직
- **테스트 표준**: 각 컴포넌트와 함수에 대한 단위 테스트 작성 필수
- **특이사항**: 사용자 인터랙션 테스트, 로딩 상태 테스트, 에러 시나리오 테스트, 덮어쓰기 확인 다이얼로그 테스트 포함

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | 초기 스토리 생성 | Scrum Master |
| 2024-12-19 | 1.1 | 스토리 구현 완료 및 테스트 통과 | Dev Agent |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (Dev Agent)

### Debug Log References
- 태그 컴포넌트 테스트 통과: 모든 사용자 인터랙션 시나리오 검증 완료
- 기존 AI 서버 액션 활용: generateTagsAction과 getTagsAction 연동 성공
- 로딩 상태 관리: 비동기 처리 중 사용자 인터랙션 방지 구현
- 덮어쓰기 다이얼로그: 기존 태그 존재 시 사용자 확인 로직 구현

### Completion Notes List
- ✅ NoteTags 컴포넌트 생성 및 구현 완료
- ✅ 노트 상세 페이지에 태그 컴포넌트 통합
- ✅ getTagsAction 서버 액션 추가
- ✅ 태그 생성 버튼 및 로딩 상태 관리
- ✅ 배지 형태 태그 표시 UI
- ✅ 에러 핸들링 및 토스트 메시지 표시
- ✅ 덮어쓰기 확인 다이얼로그 구현
- ✅ 포괄적인 단위 테스트 작성 및 통과 (13개 테스트)

### File List
- `components/notes/note-tags.tsx` - 태그 표시 및 생성 컴포넌트 (새로 생성)
- `app/notes/[id]/page.tsx` - 노트 상세 페이지 수정 (태그 컴포넌트 통합)
- `lib/actions/notes.ts` - getTagsAction 서버 액션 추가
- `lib/actions/ai.ts` - generateTagsAction 서버 액션 활용
- `__tests__/components/notes/note-tags.test.tsx` - 태그 컴포넌트 테스트 (새로 생성)
- `__tests__/lib/actions/ai.test.ts` - AI 액션 테스트 업데이트
- `jest.config.js` - Jest 설정 업데이트 (Google GenAI mock 추가)
- `__tests__/__mocks__/@google/genai.js` - Google GenAI mock 파일 (새로 생성)

## QA Results
*This section will be populated by the QA agent after implementation review*
