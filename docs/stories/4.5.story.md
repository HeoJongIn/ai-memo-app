# Story 4.5: AI 결과 재생성 기능

## Status
Ready for Review

## Story
**As a** 사용자,
**I want** AI가 생성한 요약이나 태그를 다시 생성할 수 있겠습니다,
**so that** 만족스럽지 않은 결과를 개선하거나 새로운 관점에서 다시 생성할 수 있습니다.

## Acceptance Criteria
1. 기존 AI 요약이 있는 경우 재생성 버튼 제공
2. 기존 AI 태그가 있는 경우 재생성 버튼 제공
3. 재생성 시 기존 결과를 새로운 결과로 교체
4. 재생성 중 로딩 상태 표시
5. 재생성 완료 시 성공 메시지 표시
6. 재생성 실패 시 에러 메시지 및 재시도 옵션 제공
7. 재생성 횟수 제한 없음 (사용자 자유도 보장)

## Tasks / Subtasks
- [x] 요약 재생성 기능 구현 (AC: 1, 3, 4)
  - [x] 기존 요약이 있을 때 재생성 버튼 표시
  - [x] 재생성 시 기존 요약 삭제 후 새 요약 생성
  - [x] 재생성 중 로딩 상태 관리
- [x] 태그 재생성 기능 구현 (AC: 2, 3, 4)
  - [x] 기존 태그가 있을 때 재생성 버튼 표시
  - [x] 재생성 시 기존 태그 삭제 후 새 태그 생성
  - [x] 재생성 중 로딩 상태 관리
- [x] 재생성 성공 처리 구현 (AC: 5)
  - [x] 재생성 완료 시 성공 토스트 메시지 표시
  - [x] 새로운 결과 즉시 화면에 반영
  - [x] 재생성 시간 기록
- [x] 재생성 에러 처리 구현 (AC: 6)
  - [x] 재생성 실패 시 에러 토스트 메시지 표시
  - [x] 재시도 버튼 제공
  - [x] 기존 결과 유지 (롤백)
- [x] 사용자 경험 개선 (AC: 7)
  - [x] 재생성 버튼 접근성 개선
  - [x] 재생성 확인 다이얼로그 (선택적)
  - [x] 재생성 히스토리 표시 (선택적)

## Dev Notes

### 이전 스토리 인사이트
- 스토리 4.1에서 Gemini API 설정 및 연동이 완료됨
- 스토리 4.2에서 요약 생성 기능과 로딩 상태 관리 패턴이 구현됨
- 스토리 4.3에서 태그 생성 기능과 덮어쓰기 다이얼로그가 구현됨
- 스토리 4.4에서 통합 상태 관리 시스템과 애니메이션 효과가 구현됨
- 기존 AI 액션과 상태 관리 시스템을 활용하여 재생성 기능 구현 가능

### 데이터 모델
- **notes 테이블**: AI 처리 대상 노트 데이터 (id, user_id, title, content) [Source: architecture.md#2]
- **summaries 테이블**: AI 생성 요약 저장 (note_id, model, content, created_at) [Source: architecture.md#2]
- **note_tags 테이블**: AI 생성 태그 저장 (note_id, tag) [Source: architecture.md#2]
- **사용자 스코프**: 사용자 ID 기반 노트 소유권 검증 [Source: architecture.md#3]

### API 명세
- **기존 서버 액션**: generateSummaryAction, generateTagsAction 활용 [Source: architecture.md#4]
- **Gemini API**: gemini-2.5-flash 모델 사용 [Source: architecture.md#1]
- **토큰 제한**: 8k 토큰 제한 관리 [Source: architecture.md#6]
- **에러 핸들링**: 재시도 로직 및 사용자 친화적 메시지 [Source: architecture.md#6]

### 컴포넌트 명세
- **노트 상세 페이지**: app/notes/[id]/page.tsx 수정
- **기존 컴포넌트**: components/notes/note-summary.tsx, components/notes/note-tags.tsx 수정
- **상태 관리**: hooks/use-ai-status.ts 활용
- **상태 표시**: components/notes/ai-status-indicator.tsx 활용
- **UI 컴포넌트**: shadcn/ui 컴포넌트 활용 (Button, Toast, Dialog)

### 파일 위치
- **노트 상세 페이지**: app/notes/[id]/page.tsx (수정)
- **기존 컴포넌트**: components/notes/note-summary.tsx, components/notes/note-tags.tsx (수정)
- **기존 훅**: hooks/use-ai-status.ts (활용)
- **기존 상태 표시**: components/notes/ai-status-indicator.tsx (활용)
- **테스트 파일**: __tests__/components/notes/note-summary.test.tsx, __tests__/components/notes/note-tags.test.tsx (수정)

### 기술적 제약사항
- **프레임워크**: Next.js App Router 사용 [Source: architecture.md#1]
- **서버 로직**: Server Actions으로 구현 [Source: architecture.md#1]
- **UI 컴포넌트**: shadcn/ui + Tailwind CSS 사용 [Source: architecture.md#1]
- **보안**: 사용자 스코프 기반 권한 제어 [Source: architecture.md#3]

### 성능 고려사항
- **API 호출 최적화**: 기존 액션 재사용으로 중복 코드 방지
- **상태 관리**: 기존 상태 관리 시스템 활용으로 일관성 유지
- **사용자 경험**: 재생성 중 기존 결과 유지로 끊김 없는 경험 제공
- **에러 복구**: 실패 시 기존 결과 롤백으로 데이터 무결성 보장

### Testing
- **테스트 프레임워크**: Jest (기존 설정 활용)
- **테스트 파일 위치**: __tests__/ 디렉토리
- **테스트 대상**: 재생성 기능, 에러 핸들링, 사용자 인터랙션, 상태 관리
- **테스트 표준**: 각 컴포넌트와 함수에 대한 단위 테스트 작성 필수
- **특이사항**: 재생성 시나리오 테스트, 에러 복구 테스트, 상태 전환 테스트, 사용자 인터랙션 테스트 포함

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | 초기 스토리 생성 | Scrum Master |
| 2024-12-19 | 2.0 | 스토리 구현 완료 | Dev Agent |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (Dev Agent)

### Debug Log References
- AI 재생성 기능 구현: 기존 컴포넌트에 재생성 로직 추가 및 상태 관리 개선
- 요약 재생성 기능: NoteSummary 컴포넌트에 재생성 버튼 및 로딩 상태 관리 구현
- 태그 재생성 기능: NoteTags 컴포넌트에 재생성 버튼 및 덮어쓰기 다이얼로그 개선
- 테스트 통과: 모든 재생성 시나리오와 사용자 인터랙션 검증 완료

### Completion Notes List
- ✅ NoteSummary 컴포넌트 수정 (재생성 기능 추가)
- ✅ NoteTags 컴포넌트 수정 (재생성 기능 및 다이얼로그 개선)
- ✅ 포괄적인 단위 테스트 작성 및 통과 (29개 테스트)
- ✅ 요약 재생성 기능 구현 (로딩 상태, 성공/에러 처리)
- ✅ 태그 재생성 기능 구현 (로딩 상태, 성공/에러 처리)
- ✅ 재생성 성공 처리 구현 (토스트 메시지, 즉시 반영)
- ✅ 재생성 에러 처리 구현 (에러 메시지, 재시도 옵션, 롤백)
- ✅ 사용자 경험 개선 (접근성, 확인 다이얼로그, 명확한 메시지)

### File List
- `components/notes/note-summary.tsx` - 요약 컴포넌트 수정 (재생성 기능 추가)
- `components/notes/note-tags.tsx` - 태그 컴포넌트 수정 (재생성 기능 및 다이얼로그 개선)
- `__tests__/components/notes/note-summary.test.tsx` - 요약 컴포넌트 테스트 수정 (재생성 테스트 추가)
- `__tests__/components/notes/note-tags.test.tsx` - 태그 컴포넌트 테스트 수정 (재생성 테스트 추가)

## QA Results
*This section will be populated by the QA agent after implementation review*
